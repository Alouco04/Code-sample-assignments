---
title: "Measurement of Policy Outcomes, Hwk 6"
author: "Alex Vaval"
date: "11/25/2020"
output: pdf_document
header-includes:
  - \usepackage{xcolor}
  - \usepackage{amsmath}
  - \usepackage{booktabs,threeparttable}
  
  
---

```{r,include=F}
library(haven)
library(broom)
library(tidyverse)
library(stargazer)
library(dplyr)
library(kableExtra)
library(ggplot2)
library(spatstat)
library(stats)
library(flexsurv)
library(survival)
library(descr)
library(xtable)
library(plotrix)
df.97<-read_dta("Data/panel97.dta")
df.97c<-df.97 %>% drop_na()
df.12<-read_dta("Data/pisa_2012.dta")

```



# Education in France (10 pts)


## A.
```{r,echo=F,fig.show="hold",out.width="50%"}
hist(df.97c$gscore_t1,xlab = "Test scores",
     main = "Histogram of pupils`raw grades at primary school entry ",
     breaks=100)

abline(v = median(df.97$gscore_t1, na.rm = T),col = "red",
            lwd = 2)


hist(df.97c$gscore_t2,xlab = "Test scores",
     main = "Histogram of pupils`raw grades at 3rd grade of primary school ",
     breaks = 100)
abline(v = median(df.97$gscore_t2, na.rm = T),col = "red",
            lwd = 2)

hist(df.97c$gscore_t3,xlab = "Test scores",
     main = "Histogram of pupils`raw grades at middle school entry ",
     breaks = 100)
abline(v = median(df.97$gscore_t3, na.rm = T),col = "red",
            lwd = 2)



```
Looking at the distribution of raw scores for the three periods studied, we notice  similar left skewed distributions as well as similar median scores around 70. A global interpretation would lead us to say that the majority of french pupils in elementary school are above the threshold for passing (if we consider that threshold to be 50) while a small minority performs very badly ( less than 7/20 in the french system, 35 here).

We also see that the distribution becomes wider overtime meaning an increase in the dispersion of grades of pupils.


## B.

```{r,include=F}
#probably will make a table
#g_score_t1 110

# gscore_t2 1978
#fscore_t2 1913
#mscore_t2 1978

#gscore_t3 2163
#fscore_t3 2104
#mscore_t3 2067

tab.1<-df.97%>%filter(pupil_id==1)%>%select(.)%>%
  mutate(Grade="French")%>%mutate(`First Grade`= "-")%>%
  mutate(`Third Grade`= 1913)%>%mutate(`Sixth Grade`= 2104)

tab.2<-df.97%>%filter(pupil_id==1)%>%select(.)%>%
  mutate(Grade="Maths")%>%mutate(`First Grade`= "-")%>%
  mutate(`Third Grade`= 1978)%>%mutate(`Sixth Grade`= 2067)

tab.3<-df.97%>%filter(pupil_id==1)%>%select(.)%>%
  mutate(Grade="Overall")%>%mutate(`First Grade`= 110)%>%
  mutate(`Third Grade`= 1978)%>%mutate(`Sixth Grade`= 2163)

TAB<-rbind(tab.1,tab.2,tab.3)

summary(df.97)

```

```{r,echo=F}
kable(TAB,caption="Number of Missing values in grades (NA's)",
      col.names=c("Course","First Grade","Third Grade","Sixth Grade"),
      align=c("l","c","c","c"),
      booktab=T)%>%
  kable_styling(latex_options = "HOLD_position")


```

In the table,we see the number of missing values per grade and  per test subject, and notice a few things.
The first observation that can be made, is the fact that there seems to be a systematic difference in the number of missing values between French and math, because the former seems to always have less missing values than the later.
The second observation that can be made, is the fact that the number of missing values is increasing with time.

Missing values are problematic to study pupils` progress because there might be a systematic reason difference between those that dropped out (for whom we dont have the grades) and those that continued. It may be that the poor performers are the ones for which we don't have data, this would potentially make us overestimate the general progress made by the class.We would also not be able to know where they end up.
Missing values are also problematic because the ones that dropped out are probably the ones for which we'd like to make policies for.
Lastly, they pose a problem for studying trajectories because we will have a less precise picture of the impacts of social backgrounds on performance overtime (is there a gap, how does this gap evolve overtime?)

Later in this problem set, we due notice in fact that our intuition was right regarding the students with missing values ( underperformers.)


## C.

```{r,echo=F,warning=F,message=F}

reg<-lm(df.97$gscore_t1 ~ df.97$gscore_t2)
h<-ggplot(df.97, aes(y=gscore_t1,x=gscore_t2),color=cut)+
  geom_jitter()+ theme_bw()+labs(title ="Plot of entry score on 3rd grade score"
  ,x="3rd grade score",y="Entry grade score")+ 
  geom_smooth(method='lm', se=F)
 

h







```

## D.

### (a)
To analyse the progress of pupils between the first and third grade, we would compare how their ranking relative to the other students change for each test. We are not really interested in how their raw scores evolve because we belive that the exams are not really comparable in terms of difficulty, topic covered etc...
In that regard, one method could be to see how pupil's percentiles change between 2 exams, this would give us an idea of progress. Another method could be to standardize the tests around 0 and compare how pupil's rank in terms on standard deviations and see how it evolved between tests.
Our analysis only makes sense for pupils for which we have the 3 test grades, we will therefore restrict our analysis to these pupils.


### (b)
```{r,include=F}
#df.97c<-df.97 %>% drop_na()
df.97$p_fscore_t2<-ceiling(100*ecdf(df.97$fscore_t2)
                           (df.97$fscore_t2))
df.97$p_mscore_t2<-ceiling(100*ecdf(df.97$mscore_t2)
                           (df.97$mscore_t2))
df.97$p_fscore_t3<-ceiling(100*ecdf(df.97$fscore_t3)
                           (df.97$fscore_t3))

df.97<-df.97 %>% mutate(Prog1=ifelse(p_gscore_t1
<p_gscore_t2,1,0),na.rm=T)%>% mutate(Prog2=ifelse(p_gscore_t2
<p_gscore_t3,1,0),na.rm=T)%>%mutate(var_t12=((((gscore_t2)/(gscore_t1))-1)*100),na.rm=T)%>%
mutate(var_t23=((((gscore_t3)/(gscore_t2))-1)*100),na.rm=T)%>%
  mutate(Prog1_d=ifelse(d_gscore_t1<d_gscore_t2,1,0),na.rm=T)%>% 
  mutate(Prog2_d=ifelse(d_gscore_t2<d_gscore_t3,1,0))

df.97c<-df.97 %>% drop_na()

reg1<-lm(gscore_t1~Prog1,data=df.97)
summary(reg1)

reg2<-lm(gscore_t2~Prog2,data=df.97)

#summary(reg2)

df.t1_2<-df.97c%>% select(Prog1,p_gscore_t1)%>%
  mutate(prog0=ifelse(Prog1==0,1,0))%>%
  filter(Prog1==1|prog0==1)%>%
  group_by(p_gscore_t1) %>%summarize_all(funs(sum(.)))%>%
  drop_na() %>%mutate(prog=(Prog1/(Prog1+prog0)))

df.t2_3<-df.97c%>% select(Prog2,p_gscore_t2)%>%
  mutate(prog0=ifelse(Prog2==0,1,0))%>%
  filter(Prog2==1|prog0==1)%>%
  group_by(p_gscore_t2) %>%summarize_all(funs(sum(.)))%>%
  drop_na() %>%mutate(prog=(Prog2/(Prog2+prog0)))


df.t1_2m<-df.97c%>% select(Prog1_d,d_gscore_t1)%>%
  mutate(prog0=ifelse(Prog1_d==0,1,0))%>%
  filter(Prog1_d==1|prog0==1)%>%
  group_by(d_gscore_t1) %>%summarize_all(funs(sum(.)))%>%
  drop_na() %>%mutate(prog=(Prog1_d/(Prog1_d+prog0)))

df.t2_3m<-df.97c%>% select(Prog2_d,d_gscore_t2)%>%
  mutate(prog0=ifelse(Prog2_d==0,1,0))%>%
  filter(Prog2_d==1|prog0==1)%>%
  group_by(d_gscore_t2) %>%summarize_all(funs(sum(.)))%>%
  drop_na() %>%mutate(prog=(Prog2_d/(Prog2_d+prog0)))





```



```{r,include=F}
prob<-ggplot(df.t1_2,aes(x=p_gscore_t1))+
  geom_smooth(aes(y=prog,color="1st to 3rd grade",model="lm")) +
  geom_smooth(aes(y=df.t2_3$prog,color="3rd to 6th grade",model="lm"))+
  ggtitle(label = "Probabiltiy of making progress between 2 periods",
              subtitle = "")+
  geom_hline(yintercept=0.5, linetype="dashed", color = "red")+
  theme(
  plot.title = element_text(hjust = 0.5),
  plot.subtitle = element_text(hjust = 0.5)
)+labs(x = " Percentile of grades",
         y = "Share of pupils having made progress",
         color = "Legend") 

prob


mag<-ggplot(df.t1_2m,aes(x=d_gscore_t1))+
  geom_smooth(aes(y=prog,color="1st to 3rd grade",model="lm")) +
  geom_smooth(aes(y=df.t2_3m$prog,color="3rd to 6th grade",model="lm"))+
  ggtitle(label = "Percentage change of score between 2 tests",
              subtitle = "")+
  geom_hline(yintercept=0, linetype="dashed", color = "red")+
  theme(
  plot.title = element_text(hjust = 0.5),
  plot.subtitle = element_text(hjust = 0.5)
)+labs(x = " Percentile of grades",
         y = "Change in grades (%)",
         color = "Legend") 

mag
```

```{r,echo=F,fig.show="hold",warning=F,message=F}

prob



```
Our strategy to evaluate the progress of pupils is a general one. On the y axis, we have the share of pupils going to a higher percentile of grades between the two tests. On the x axis, we have the percentile of pupils in the grade distribution. Progress for the sake of this question is defined as being in a higher percentile in test period t+1 than period t.

What we see is that globally ( between t1 and t2, between t2 and t3), those scoring in the lower percentiles had a higher probability of being in a higher percentile on the next test. Indeed,looking specifically at each curve (figure 1), we see that people scoring in the bottom 40 percentile of grades in first grade, had a more than 50% chance to be in a higher percentile of grades in the third grade. 
While looking at the progress between the 3rd grade test and 6th grade test, we see that those that score in the bottom 3/5th in for the starting test had more than 50% chance of being in a higher percentile for the ending test. 

Lastly, if we look at the top of percentiles, we notice a slight increase in the amount of people that got to a higher percentile between the 2 periods of comparison, however this difference is not statistically significant but it implies that there is a tendency for pupils in the top and bottom of the distribution to make progress.







## E.

```{r,include=F}

df.97<-df.97%>% mutate(d_gscore_t1= ifelse(is.na(d_gscore_t1),11,d_gscore_t1))%>%
  mutate(d_gscore_t2=ifelse(is.na(d_gscore_t2),11,d_gscore_t2))%>%
  mutate(d_gscore_t3=ifelse(is.na(d_gscore_t3),11,d_gscore_t3))

de.cross<- crosstab(df.97$d_gscore_t1, df.97$d_gscore_t2, 
                    xlab="Deciles Test 2", 
                    ylab ="Deciles Test 1", prop.r = T)[2]

de.cross<- data.frame(de.cross)
TAB1 <- matrix(de.cross[,3], nrow=11)
TAB1 <- data.frame(TAB1)*100
Tab<-TAB1 %>%mutate(`3rd Grade`="")%>%
  select(`3rd Grade`,X1,X2,X3,X4,X5,X6,X7,X8,X9,X10,X11)

a<-df.97%>%filter(pupil_id==1)%>%select(.)%>%
  mutate(s="D1")
b<-df.97%>%filter(pupil_id==1)%>%select(.)%>%
  mutate(s="D2")
c<-df.97%>%filter(pupil_id==1)%>%select(.)%>%
  mutate(s="D3")
d<-df.97%>%filter(pupil_id==1)%>%select(.)%>%
  mutate(s="D4")
e<-df.97%>%filter(pupil_id==1)%>%select(.)%>%
  mutate(s="D5")
f<-df.97%>%filter(pupil_id==1)%>%select(.)%>%
  mutate(s="D6")
g<-df.97%>%filter(pupil_id==1)%>%select(.)%>%
  mutate(s="D7")
h<-df.97%>%filter(pupil_id==1)%>%select(.)%>%
  mutate(s="D8")
i<-df.97%>%filter(pupil_id==1)%>%select(.)%>%
  mutate(s="D9")
j<-df.97%>%filter(pupil_id==1)%>%select(.)%>%
  mutate(s="D10")
k<-df.97%>%filter(pupil_id==1)%>%select(.)%>%
  mutate(s="NA")

Bind<-rbind(a,b,c,d,e,f,g,h,i,j,k)
TAB1<-cbind(Tab,Bind)%>%
  select(s,`3rd Grade`,X1,X2,X3,X4,X5,X6,X7,X8,X9,X10,X11)


#second period
de.cross2<- crosstab(df.97$d_gscore_t2, df.97$d_gscore_t3, 
main="Illustration of Transition Probabilities, T2-3",
xlab="Deciles Test 3", ylab = "Deciles Test 2", prop.r = T)[2]

de.cross2<- data.frame(de.cross2)
tab2 <- matrix(de.cross2[,3], nrow=11)
tab2 <- data.frame(tab2)*100
tab2<-tab2 %>%mutate(`6th Grade`="")%>%
  select(`6th Grade`,X1,X2,X3,X4,X5,X6,X7,X8,X9,X10,X11)

a<-df.97%>%filter(pupil_id==1)%>%select(.)%>%
  mutate(s="D1")
b<-df.97%>%filter(pupil_id==1)%>%select(.)%>%
  mutate(s="D2")
c<-df.97%>%filter(pupil_id==1)%>%select(.)%>%
  mutate(s="D3")
d<-df.97%>%filter(pupil_id==1)%>%select(.)%>%
  mutate(s="D4")
e<-df.97%>%filter(pupil_id==1)%>%select(.)%>%
  mutate(s="D5")
f<-df.97%>%filter(pupil_id==1)%>%select(.)%>%
  mutate(s="D6")
g<-df.97%>%filter(pupil_id==1)%>%select(.)%>%
  mutate(s="D7")
h<-df.97%>%filter(pupil_id==1)%>%select(.)%>%
  mutate(s="D8")
i<-df.97%>%filter(pupil_id==1)%>%select(.)%>%
  mutate(s="D9")
j<-df.97%>%filter(pupil_id==1)%>%select(.)%>%
  mutate(s="D10")
k<-df.97%>%filter(pupil_id==1)%>%select(.)%>%
  mutate(s="NA")

Bind2<-rbind(a,b,c,d,e,f,g,h,i,j,k)
TAB2<-cbind(tab2,Bind)%>%
  select(s,`6th Grade`,X1,X2,X3,X4,X5,X6,X7,X8,X9,X10,X11)



```

```{r,echo=F,tab.show="hold",out.width="50%"}

kable(TAB1,caption="Transition matrix for
      pupil's evolution (1st-3rd grade)",
      col.names=c("","3rd grade","D1","D2","D3","D4","D5","D6","D7","D8","D9","D10","NA"),
      align=c("l","r","c","c","c","c","c","c","c","c","c","c","r"),
      booktab=T,digits =2 )%>%
  pack_rows("1st grade",1,11)%>%
  kable_styling(latex_options = "HOLD_position")

kable(TAB2,caption="Transition matrix for pupil's evolution (3rd-6th grade)",
      col.names=c("","6th","D1","D2","D3","D4","D5","D6","D7","D8","D9","D10","NA"),
      align=c("l","r","c","c","c","c","c","c","c","c","c","c","r"),
      booktab=T,digits =2 )%>%
  pack_rows("3rd grade",1,11)%>%
  kable_styling(latex_options = "HOLD_position")
```
The transition matrices above tell us, given that a pupil was in a given decile in the starting test, what is the probability hat she/he is in a given decile of the distribution in the ending test.

Looking at the tables we can make multiple observations. First, it seems that decile reproduction is the highest at either ends of the distribution (those scoring in the D1/D10 in test 1, seem to have a higher probability to score in the D1/D10 for the test 2), the same observation can be made between test 2 and test 3. However, we do see an increase in Decile reproduction between test 2 and test 3 as compared to test 1 and test 2.

Second, it seems that the bottom deciles in test 1 have a higher probability of attrition in test 2 signaling that attrition is not random and strongly linked to poor performing students.That is however not the case between test 2 and test 3 where the probabilities of attrition seems to be balanced around 15% meaning that attrition is actually random for them. 

Third,it seems that the majority of change decile either move 1 decile above or below their initial decile,at least one fourth between test 1 and test 2 but that is more true for  the bottom 4 and the top 3 deciles signaling that pupils in general have a low probability of shifting to the opposite side of the grade distribution between tests.The probability of being in a neighboring decile increases between test 2 and test 3.



## F.
### (a)
```{r,include=F}
df.97c<-df.97 %>%drop_na()
df.97m<-df.97c%>%mutate(Z_scoret1=
  (gscore_t1-mean(gscore_t1))/sqrt(var(gscore_t1)))%>%
  mutate(Z_scoret2=
  (gscore_t2-mean(gscore_t2))/sqrt(var(gscore_t2)))%>%
   mutate(Z_scoret3=
  (gscore_t3-mean(gscore_t3))/sqrt(var(gscore_t3)))%>%
  filter(birthm==1|birthm==12)%>%mutate(
  birthm=ifelse(birthm==1,0,1))


reg_t1<-lm(Z_scoret1~birthm,data=df.97m)
reg_t2<-lm(Z_scoret2~birthm,data=df.97m)
reg_t3<-lm(Z_scoret3~birthm,data=df.97m)

summary(reg_t1)
summary(reg_t2)
summary(reg_t3)

```


\begin{table}[H] \centering 
  \caption{Regression of Z-score of test scores while controlling for birth month} 
  \label{} 
\begin{tabular}{@{\extracolsep{5pt}}lccc} 
\\[-1.8ex]\hline 
\hline \\[-1.8ex] 
 & \multicolumn{3}{c}{\textit{Z-scores of scores in:}} \\ 
\cline{2-4} 
\\[-1.8ex] & 1st grade & 3rd grade & 6th grade \\ 
\\[-1.8ex] & (1) & (2) & (3)\\ 
\hline \\[-1.8ex] 
 Birth month & $-$0.587 & $-$0.429 & $-$0.282 \\ 
  & (0.060) & (0.060) & (0.062) \\ 
  & & & \\ 
 Constant & 0.269 & 0.194 & 0.132 \\ 
  & (0.042) & (0.042) & (0.043) \\ 
  & & & \\ 
\hline \\[-1.8ex] 
Observations & 1,048 & 1,048 & 1,048 \\ 
\hline 
\hline \\[-1.8ex] 
\end{tabular} 
\begin{tablenotes}\labelsep0.0em\scriptsize
\item \emph{Notes}:The standard errors are in parenthesis.The variable "Birth month" is a binary variable equal to 0 if the Birth month is "January" and 1 if  the Birth month is "December".
\item \emph{Example of reading}: During the first grade exam, pupils born in january had an average grade 0.269 standard deviation above the mean score while those born in December had a test score 0.582 standard deviation lower than them.
\end{tablenotes}
\end{table} 




The formula for a confidence interval (CI) is : 

$$CI=[\mu^-_+1.96 *\frac{\sigma}{\sqrt{N}}]$$
Using this formula for each test score where $\mu$ is the average difference between the two groups, we find:

- For test 1, $CI=[-0.705 ;-0.469]$
- For test 2, $CI=[-0.547 ;-0.311]$
- For test 3, $CI=[-0.404 ;-0.160]$

We can say that there exists a statistically significant difference between pupils born in January and December, more precisely, the pupils born in December seem to persistently perform worse ( in every year).The difference seem to be attenuated overtime going from at most 0.705 standard deviation for test 1 to at most 0.404 point less for test 3 signalling a reduction of disparities between pupils.

Let us mention that for this question and the following questions, the Z-score is calculate before filtering. Therefore, our results should be interpreted relative to the whole distribution for the Constant estimate.



### (b)

```{r,include=F}
df.97p<-df.97c %>%
  mutate(Z_scoret1=
  (gscore_t1-mean(gscore_t1))/sqrt(var(gscore_t1)))%>%
  mutate(Z_scoret2=
  (gscore_t2-mean(gscore_t2))/sqrt(var(gscore_t2)))%>%
   mutate(Z_scoret3=
  (gscore_t3-mean(gscore_t3))/sqrt(var(gscore_t3)))%>%
  filter(parent_occ==3|parent_occ==6)%>%
  mutate(parent_occ=ifelse(parent_occ==3,0,1))


reg_t1P<-lm(Z_scoret1~parent_occ,data=df.97p)
reg_t2P<-lm(Z_scoret2~parent_occ,data=df.97p)
reg_t3P<-lm(Z_scoret3~parent_occ,data=df.97p)




```


\begin{table}[H] \centering 
  \caption{Regression of Z-score of test scores while controlling for parent's social category} 
  \label{} 
\begin{tabular}{@{\extracolsep{5pt}}lccc} 
\\[-1.8ex]\hline 
\hline \\[-1.8ex] 
 & \multicolumn{3}{c}{\textit{Z-scores of scores in:}} \\ 
\cline{2-4} 
\\[-1.8ex] & 1st grade & 3rd grade & 6th grade \\ 
\\[-1.8ex] & (1) & (2) & (3)\\ 
\hline \\[-1.8ex] 
 Parent Occupation & $-$0.754 & $-$0.792 & $-$0.959 \\ 
  & (0.037) & (0.036) & (0.036) \\ 
  & & & \\ 
 Constant & 0.486 & 0.519 & 0.611 \\ 
  & (0.030) & (0.030) & (0.030) \\ 
  & & & \\ 
\hline \\[-1.8ex] 
Observations & 3,054 & 3,054 & 3,054 \\ 
\end{tabular} 
\begin{tablenotes}\labelsep0.0em\scriptsize
\item \emph{Notes}:The standard errors are in parenthesis.The variable "Parent occupation" is a binary variable equal to 0 if the parent's occupation is "executives/professionals" and 1 if  the parent's occupation is "blue collar".
\item \emph{Example of reading}: During the first grade exam, pupils  with a parent in the "Executives/professionals" social category had an average grade 0.486 standard deviation above the mean score while those with a parent in the "blue collar" social category had a test score 0.752 standard deviation lower than them.
\end{tablenotes}
\end{table} 



Using the formula used previously, we find the following confidence intervalls:

- For test 1, $CI=[-0.827 ;-0.681]$
- For test 2, $CI=[-0.863 ;-0.721]$
- For test 3, $CI=[-1.03;-0.888]$

There seems to be a difference between pupils with parents in the "Executives/professionals" category and those with a parent in the "Blue collar category, the former having systematically higher grades than the latter.
Furthermore this difference increases overtime, from at most 0.827 standard deviations for test 1 to at most 1.03 standard deviations for test 3, whereas it was decreasing to pupils born in  the two different months.

One difference is simply due to the relative amount of time spent learning, for example pupils born in january have 11 more months of experience and stimuli than those born in december. When young, this difference is impactful on pupils' performance, but with time, this difference should no longer impact grades. The other is due to institutional factors, indeed, here we see the impact of social class on pupil's performance.Those in the with highly educated parents seem to be performing very highly benefiting from more financial resources(private tutors for example), cultural (have more mental stimuli) and social capital than those from lowly educated parents. These factors accumulate overtime and become more meaningful.


### (c)
It is possible for our result to be biased because, some pupils might have had to redo the class and the exams again. Therefore, some students born in december but that re-did the class will score more than their fellow comrades born in december because they would've had more time to master the material (in theory) and their would be no difference between them and the january pupils.

We strongly believe that the distribution of those that redo the classes are different between these 2 months, they are very certainly relatively more numerous in for the month of december than january.

\pagebreak

# Education in OECD countries

## 1.

There are no missing values plausible values for any of the subjects, which seem implausible for a data set of 23087 observations.

There are missing values for some of the other variables, we therefore decided to make a table to show the missing values only when that number is positive.



```{r,include=F}
missing_variables <- df.12 %>% summarise_all(funs(sum(is.na(.))))
print.data.frame(missing_variables)

missing_variables <- missing_variables %>%
  mutate(Variable = "Frequency (abs)") %>% 
  select(Variable, AGE, GRADE, ST06Q01, SCMAT, ANXMAT, FAILMAT, INSTMOT,INTMAT, MATBEH, MATHEFF, MATINTFC, PERSEV, OPENPS, SUBNORM, FAMCON)


missing_variables_share <- df.12 %>% summarise_all(funs(mean(is.na(.)*100)))
print.data.frame(missing_variables_share)

missing_variables_share <- missing_variables_share %>%
  mutate(Variable = "Frequency(%)") %>% 
  select(Variable, AGE, GRADE, ST06Q01, SCMAT, ANXMAT, 
         FAILMAT, INSTMOT,INTMAT, MATBEH, MATHEFF, MATINTFC, PERSEV, OPENPS, SUBNORM, FAMCON)

mvt1 <- rbind(missing_variables, missing_variables_share) %>%
  select(Variable,AGE,GRADE,ST06Q01,SCMAT,ANXMAT,FAILMAT,INSTMOT)

mvt2<-rbind(missing_variables, missing_variables_share) %>%
  select(Variable,INTMAT,MATBEH, MATHEFF, MATINTFC,PERSEV, OPENPS, SUBNORM, FAMCON)


```

```{r,echo=F}
kable(mvt1,caption="Table of missing values for variables with missing values",
      col.names=c("Variable","AGE","GRADE","ST06Q01","SCMAT","ANXMAT","FAILMAT","INSTMOT"),
      align=c("l","c","c","c","c","c","c","c"),
      booktab=T,digits =2 )%>%
  kable_styling(latex_options = "HOLD_position")

kable(mvt2,caption="Table of missing values for variables with missing values",
      col.names=c("Variable","INTMAT","MATBEH", "MATHEFF","MATINTFC","PERSEV", "OPENPS", "SUBNORM","FAMCON"),
      align=c("l","c","c","c","c","c","c","c","c"),
      booktab=T,digits =2 )%>%
  kable_styling(latex_options = "HOLD_position")


```


## 2.

```{r,include=F}


pisa_config <- list("variables","parameters")
pisa_config$variables$weightFinal<-"WEIGHT"
pisa_config$variables$weightBRR <-"W_FSTR"
pisa_config$parameters$BRRreps <- as.numeric(80) # number of replication weights

#>>> Functions >>>

#>>> Mean estimation for plausible values

fun.pv <- function (pvnames, data, folder = getwd()) {
  #call a function with the possible values as variable and our data frame as data.
 
    R.mean <- sapply(pvnames, function(k) sapply(1:pisa_config$parameters$BRRreps, 
                                                 function(i) weighted.mean(data[[k]], 
#Apply to a vector r.mean, the sapply(which turns list/dataframe into a vector) function. We then use another function sapply withing the first one, that will run from 1 to 80,  balanced repeated replications of the weighted mean of the possible values.

                                                                           data[[paste0(pisa_config$variables$weightBRR,i)]], na.rm = TRUE)))
    PV.mean <- sapply(pvnames, function(x) weighted.mean(data[[x]], 
                                                         data[[pisa_config$variables$weightFinal]], na.rm = TRUE))
    MEAN.m <- mean(PV.mean)
    cc = 1/20
    
    var.mean.w <- mean(sapply(seq_along(pvnames), function(i) cc *sum((R.mean[, i] - PV.mean[i])^2)))
    
    var.mean.b <- (1/(length(pvnames) - 1)) * sum(sapply(seq_along(pvnames), function(i) (PV.mean[i] - MEAN.m)^2)) 
    
    mean.se <- (var.mean.w + (1 + 1/length(pvnames)) * var.mean.b)^(1/2)
    
    LB <- MEAN.m - 1.96*mean.se
    UB <- MEAN.m + 1.96*mean.se
    
    result <- data.frame(Freq = length(data[[pisa_config$variables$weightFinal]]), 
                         Mean = mean(MEAN.m), s.e. = mean.se, LB = LB, UB = UB)
    
    return(round(result, 2))
}

#>>> Mean estimation for standard variables

fun <- function(variable, data) {
  
  meanrp <- sapply(1:pisa_config$parameters$BRRreps, function(i) weighted.mean(as.numeric(data[[variable]]), 
                                                                               data[[paste(pisa_config$variables$weightBRR, i, sep = "")]], 
                                                                               na.rm = TRUE))
  meantot <- weighted.mean(as.numeric(data[[variable]]), 
                           data[[pisa_config$variables$weightFinal]], na.rm = TRUE)
  
  meanse <- (0.05 * sum((meanrp - meantot)^2))^(1/2)
  
  LB <- meantot - 1.96*meanse
  UB <- meantot + 1.96*meanse
  
  result <- data.frame(Freq = sum(!is.na(data[[variable]])), 
                       Mean = meantot, s.e. = meanse, LB = LB, UB = UB)
  return(round(result, 2))
  
}

pv.math <- c("PV1MATH", "PV2MATH", "PV3MATH", "PV4MATH", "PV5MATH")
pv.read <- c("PV1READ", "PV2READ", "PV3READ", "PV4READ", "PV5READ")
pv.scien <- c("PV1SCIE", "PV2SCIE", "PV3SCIE", "PV4SCIE", "PV5SCIE")

### Maths

m_finland <- fun.pv(pv.math, df.12[df.12$CNT=="Finland", ] , folder= getwd())
m_france <- fun.pv(pv.math, df.12[df.12$CNT=="France", ] , folder= getwd())
m_norway <- fun.pv(pv.math, df.12[df.12$CNT=="Norway", ] , folder= getwd())
m_vietnam <- fun.pv(pv.math, df.12[df.12$CNT=="Viet Nam", ] , folder= getwd())


df_maths <- as.data.frame(rbind(m_finland, m_france, m_norway, m_vietnam)) %>%
  mutate(Country = c("Finland", "France", "Norway", "Vietnam")) %>%
  select(Country, Mean, s.e., LB, UB, Freq)%>%
  select(Country, Mean, s.e., LB, UB, Freq)%>%mutate(DFin=ifelse(Country
  =="Finland",1,0))%>%mutate(Dnor=ifelse(Country
  =="Norway",1,0))%>%mutate(Dfr=ifelse(Country
  =="France",1,0))%>%mutate(Dviet=ifelse(Country
  =="Vietnam",1,0))


### Reading

r_finland <- fun.pv(pv.read, df.12[df.12$CNT=="Finland", ] , folder= getwd())
r_france <- fun.pv(pv.read, df.12[df.12$CNT=="France", ] , folder= getwd())
r_norway <- fun.pv(pv.read, df.12[df.12$CNT=="Norway", ] , folder= getwd())
r_vietnam <- fun.pv(pv.read, df.12[df.12$CNT=="Viet Nam", ] , folder= getwd())


df_reading <- as.data.frame(rbind(r_finland, r_france, r_norway, r_vietnam)) %>%
  mutate(Country = c("Finland", "France", "Norway", "Vietnam")) %>%
  select(Country, Mean, s.e., LB, UB, Freq)%>%
  select(Country, Mean, s.e., LB, UB, Freq)%>%mutate(DFin=ifelse(Country
  =="Finland",1,0))%>%mutate(Dnor=ifelse(Country
  =="Norway",1,0))%>%mutate(Dfr=ifelse(Country
  =="France",1,0))%>%mutate(Dviet=ifelse(Country
  =="Vietnam",1,0))


### Sciences

s_finland <- fun.pv(pv.scien, df.12[df.12$CNT=="Finland", ] , folder= getwd())
s_france <- fun.pv(pv.scien, df.12[df.12$CNT=="France", ] , folder= getwd())
s_norway <- fun.pv(pv.scien, df.12[df.12$CNT=="Norway", ] , folder= getwd())
s_vietnam <- fun.pv(pv.scien, df.12[df.12$CNT=="Viet Nam", ] , folder= getwd())


df_science <- as.data.frame(rbind(s_finland, s_france, s_norway, s_vietnam)) %>%
  mutate(Country = c("Finland", "France", "Norway", "Vietnam"))%>%
  select(Country, Mean, s.e., LB, UB, Freq)%>%mutate(DFin=ifelse(Country
  =="Finland",1,0))%>%mutate(Dnor=ifelse(Country
  =="Norway",1,0))%>%mutate(Dfr=ifelse(Country
  =="France",1,0))%>%mutate(Dviet=ifelse(Country
  =="Vietnam",1,0))

#stargazer(as.data.frame(df_maths), title="Avg. Student Performance − Mathematics ", digits =3, header=F, summary=F)
#stargazer(as.data.frame(df_reading), title="Avg. Student Performance − Reading", digits =3, header=F, summary=F)
#stargazer(as.data.frame(df_science), title="Avg. Student Performance − Science", digits =3, header=F, summary=F)
```
The fun.pv function uses plausible values to compute the mean and its standard error.

We first start by creating a vector with different values and 2 variables.
Then, we input to fun.pv the a function taking as argument the plausible value names, the dataframe and the folder.
Third, we compute the weighted mean of a variable k  80 times by using the Balanced Repeated Replication method.
Fourth, we compute the plausible value weighted mean by using the final weights to have the total weighted mean (individuals are the weights) of plausible value x.
Fourth, we do the mean of the plausible values and input it int the object Mean.m.
Fifth, we compute the variance of our 80 Balanced repetition by doing the difference between the mean of the repetition minimus the total plausible value mean then we square it.
Sixth, we compute the  sample variance of the mean of our plausible value.
Seventh, we compute the standard error of the mean of plausible value to which we add the variance of the mean of the balanced replication
Eighth, we compute the Upper and lower boound of the  95 %confidence interval of the mean of the mean of the plausible values.
Lastly, we create a dataframe, with our needed descriptive statistics variable.





\begin{table}[H] \centering 
  \caption{Descriptive statistics of Scores in 3 subjects for the 4 given countries} 
  \label{} 
\begin{tabular}{@{\extracolsep{5pt}}lccccc}
\\\hline  
 & &\multicolumn{1}{c}{Finland} & \multicolumn{1}{c}{France} & \multicolumn{1}{c}{Norway} & \multicolumn{1}{c}{Vietnam}\\
Subject  & Desc.stat  &  &  & &   \\
\hline \\[-1.8ex] 
Math & Mean  & 518.75 &  494.98 &  489.37 & 511.34        \\
  & Std.Error  & 1.94 & 2.45 & 2.73 & 4.84      \\
  & CI & \color{red}{514.95-522.55} & \textcolor{blue}{490.17-499.8}  & \textcolor{blue}{484.01-494.73} &  \textcolor{red}{501.85-520.83}     \\
  & & & & &  \\ 
 \hline
  & & & &   \\ 
Reading & Mean  & $\boldsymbol{524.02^{1}}$ &  505.48 &  503.94   &  508.22   \\
  & Std.Error  & 2.38 & 2.83 & 3.22  & 4.40  \\
  & CI & 519.35-528.69 & \color{blue}{499.94-511.02} & \color{blue}{497.63-510.24} & \color{blue}{499.60-516.84}   \\
& & & & &  \\ 

 \hline 
Science & Mean  & $\boldsymbol{545.44}$$^{1}$ &  498.97 &  494.52  &  $\boldsymbol{528.42}$$^{2}$   \\
  & Std.Error  & 2.2 & 2.58 & 3.09   &  4.31 \\
  & CI & 541.13-549.75 & \textcolor{blue}{493.92-504.03} & \textcolor{blue}{488.47-500.58} &  519.97-536.88     \\ 
& & & & &  \\ 
 \hline
  & Observations & 8,829 & 4,613 & 4,686 & 4,959 \\ 
\hline 
\hline \\[-1.8ex] 
\end{tabular}
\end{table}

It looks like we can not clearly rank all the countries in a meaningful way.Indeed,when looking at the table, we see that there is no statistical difference in terms of grades for any subject between Norway and France (CI overlap).It is also the case for Finland and Viet nam in Maths.
Nonetheless, some ranking can be made. For example Finnish students seem to outperform the other students in Reading and Science in a statistically significant way. Vietnamese students seem to score significantly better than the students from France and Norway but less than the Finish students when it comes to Science. Lastly, Both Finland and Vietnam seem to outperform Norway and France but more precise ranking can not be made.

It could be argued that the mean is not the best measure to represent students, the median might be a better tool to accurately represent the average pupil of the country. It could also be argued that, students in different countries learn different things at a given age and therefore there should be no comparison to be made which makes sense.



Multiple factors may explain differences across countries when it comes to the pupils` scores.

First, the quality of the teaching force,some countries have a highly selective curriculum to become a teacher, and also require a high level of education, this is the case of Finland for example.

Second, the resources allocated to education both in per capita and Gross  terms. We would expect, countries that dedicate have higher spending per capita and higher spending as percentage of GDP to have pupils that perform better, mostly because they'll have more capital (desk,computers,software) to learn and more personalized care( high teacher per capita ratio,small class size) to learn better. On the teacher side, more ressources in terms of higher salary give them incentive to love and better do their job in passing knowledge.

Third, autonomy and accountability can also vary across countries and it has an important impact on pupils performance. Indeed, countries where school have ressources but are also able to decide how to use them should perform better because they have more information than the administration in terms of knowing what their needs are. Accountable schools, should theoretically perform better because they have incentives to do so as compared to schools where there is no relationship between performance and funding. 

Lastly, the composition of the exam takers in different countries is an important factor in explaining differences. For example, if the students taking the exams come from excusively wealthy families as may be the case for developing countries specifically( Viet nam), that might lead us to believe that the students of viet nam perform very well overall. However, it is not the case, it is simply that the pupils studied are not representative of the whole population.


## 3.

```{r,include=F}


pisa_config <- list("variables","parameters")
pisa_config$variables$weightFinal<-"WEIGHT"
pisa_config$variables$weightBRR <-"W_FSTR"
pisa_config$parameters$BRRreps <- as.numeric(80) # number of replication weights

#>>> Functions >>>

#>>> Mean estimation for plausible values

fun.pv <- function (pvnames, data, folder = getwd()) {
 
    R.mean <- sapply(pvnames, function(k) sapply(1:pisa_config$parameters$BRRreps, 
                                                 function(i) weighted.mean(data[[k]], 
                                                                           data[[paste0(pisa_config$variables$weightBRR,i)]], na.rm = TRUE)))
    PV.mean <- sapply(pvnames, function(x) weighted.mean(data[[x]], 
                                                         data[[pisa_config$variables$weightFinal]], na.rm = TRUE))
    MEAN.m <- mean(PV.mean)
    cc = 1/20
    
    var.mean.w <- mean(sapply(seq_along(pvnames), function(i) cc *sum((R.mean[, i] - PV.mean[i])^2)))
    
    var.mean.b <- (1/(length(pvnames) - 1)) * sum(sapply(seq_along(pvnames), function(i) (PV.mean[i] - MEAN.m)^2)) 
    
    mean.se <- (var.mean.w + (1 + 1/length(pvnames)) * var.mean.b)^(1/2)
    
    LB <- MEAN.m - 1.96*mean.se
    UB <- MEAN.m + 1.96*mean.se
    
    result <- data.frame(Freq = length(data[[pisa_config$variables$weightFinal]]), 
                         Mean = mean(MEAN.m), s.e. = mean.se, LB = LB, UB = UB)
    
    return(round(result, 2))
}

#>>> Mean estimation for standard variables

fun <- function(variable, data) {
  
  meanrp <- sapply(1:pisa_config$parameters$BRRreps, function(i) weighted.mean(as.numeric(data[[variable]]), 
                                                                               data[[paste(pisa_config$variables$weightBRR, i, sep = "")]], 
                                                                               na.rm = TRUE))
  meantot <- weighted.mean(as.numeric(data[[variable]]), 
                           data[[pisa_config$variables$weightFinal]], na.rm = TRUE)
  
  meanse <- (0.05 * sum((meanrp - meantot)^2))^(1/2)
  
  LB <- meantot - 1.96*meanse
  UB <- meantot + 1.96*meanse
  
  result <- data.frame(Freq = sum(!is.na(data[[variable]])), 
                       Mean = meantot, s.e. = meanse, LB = LB, UB = UB)
  return(round(result, 2))
  
}

pv.math <- c("PV1MATH", "PV2MATH", "PV3MATH", "PV4MATH", "PV5MATH")
pv.read <- c("PV1READ", "PV2READ", "PV3READ", "PV4READ", "PV5READ")
pv.scien <- c("PV1SCIE", "PV2SCIE", "PV3SCIE", "PV4SCIE", "PV5SCIE")

### Maths

m_boys <- fun.pv(pv.math, df.12[df.12$GENDER==1, ] , folder= getwd())
m_girls <- fun.pv(pv.math, df.12[df.12$GENDER==0, ] , folder= getwd())

df_maths.s <- as.data.frame(rbind(m_boys,m_girls)) %>%
  mutate(Sexe = c("Boys","Girls")) %>%
  select(Sexe, Mean, s.e., LB, UB, Freq)
 

### Reading

r_boys <- fun.pv(pv.read, df.12[df.12$GENDER==1, ] , folder= getwd())
r_girls <- fun.pv(pv.read, df.12[df.12$GENDER==0, ] , folder= getwd())


df_reading.s <-  as.data.frame(rbind(r_boys,r_girls)) %>%
  mutate(Sexe = c("Boys","Girls")) %>%
  select(Sexe, Mean, s.e., LB, UB, Freq)

### Sciences

s_boys <- fun.pv(pv.scien, df.12[df.12$GENDER==1, ] , folder= getwd())
s_girls <- fun.pv(pv.scien, df.12[df.12$GENDER==0, ] , folder= getwd())



df_science.s <- as.data.frame(rbind(s_boys,s_girls)) %>%
  mutate(Sexe = c("Boys","Girls")) %>%
  select(Sexe, Mean, s.e., LB, UB, Freq)
  
  

```

\begin{table}[H] \centering 
  \caption{Grade comparison for 3 subjects depending on Gender} 
  \label{} 
\begin{tabular}{@{\extracolsep{5pt}}lccccc}
\\\hline  
 & &\multicolumn{1}{c}{Male} & \multicolumn{1}{c}{Female} \\
Subject  & Desc.stat  &  &     \\
\hline \\[-1.8ex] 
Math & Mean  & $\boldsymbol{508.77}$ &  500.44        \\
  & Std.Error  & 3.43 & 2.88     \\
  & CI & {502.06$-$515.48} & {494.80$-$506.08}     \\
  & & &   \\ 
 \hline
  & & &   \\ 
Reading & Mean  & {487.91} &  $\boldsymbol{525.37}${$^{*}$}   \\
  & Std.Error  & 3.18 & 2.58  \\
  & CI & 481.69$-$494.14 & {520.33$-$530.42}    \\
& & &   \\ 

 \hline 
Science & Mean  & 515.41 &  $\boldsymbol{517.03}$   \\
  & Std.Error  & 3.40 & 2.64  \\
  & CI & {508.75$-$522.08} & {511.84$-$522.21}     \\ 
& & &  \\ 
 \hline
  & Observations & 11,403 & 11,684  \\ 
\hline 
\hline \\[-1.8ex] 
\end{tabular}
\end{table}


Overall, it doesn't look like there is a persistent difference between guys and girls across subject. Indeed, doing the naive comparison of means, guys seem to score better than girls in Math only while girls seem to perform better in Reading in Science. Because we cannot do a means test, there is no way of making sure that the difference is the statistically significant. The only exception would be for reading because the confidence intervalls do not cross at all, therefore we can cautiously assume that girls perform better than guys.






## 4.
```{r,include=F}

pisa_config <- list("variables","parameters")
pisa_config$variables$weightFinal<-"WEIGHT"
pisa_config$variables$weightBRR <-"W_FSTR"
pisa_config$parameters$BRRreps <- as.numeric(80) # number of replication weights

#>>> Functions >>>

#>>> Mean estimation for plausible values

fun.pv <- function (pvnames, data, folder = getwd()) {
 
    R.mean <- sapply(pvnames, function(k) sapply(1:pisa_config$parameters$BRRreps, 
                                                 function(i) weighted.mean(data[[k]], 
                                                                           data[[paste0(pisa_config$variables$weightBRR,i)]], na.rm = TRUE)))
    PV.mean <- sapply(pvnames, function(x) weighted.mean(data[[x]], 
                                                         data[[pisa_config$variables$weightFinal]], na.rm = TRUE))
    MEAN.m <- mean(PV.mean)
    cc = 1/20
    
    var.mean.w <- mean(sapply(seq_along(pvnames), function(i) cc *sum((R.mean[, i] - PV.mean[i])^2)))
    
    var.mean.b <- (1/(length(pvnames) - 1)) * sum(sapply(seq_along(pvnames), function(i) (PV.mean[i] - MEAN.m)^2)) 
    
    mean.se <- (var.mean.w + (1 + 1/length(pvnames)) * var.mean.b)^(1/2)
    
    LB <- MEAN.m - 1.96*mean.se
    UB <- MEAN.m + 1.96*mean.se
    
    result <- data.frame(Freq = length(data[[pisa_config$variables$weightFinal]]), 
                         Mean = mean(MEAN.m), s.e. = mean.se, LB = LB, UB = UB)
    
    return(round(result, 2))
}

#>>> Mean estimation for standard variables

fun <- function(variable, data) {
  
  meanrp <- sapply(1:pisa_config$parameters$BRRreps, function(i) weighted.mean(as.numeric(data[[variable]]), 
                                                                               data[[paste(pisa_config$variables$weightBRR, i, sep = "")]], 
                                                                               na.rm = TRUE))
  meantot <- weighted.mean(as.numeric(data[[variable]]), 
                           data[[pisa_config$variables$weightFinal]], na.rm = TRUE)
  
  meanse <- (0.05 * sum((meanrp - meantot)^2))^(1/2)
  
  LB <- meantot - 1.96*meanse
  UB <- meantot + 1.96*meanse
  
  result <- data.frame(Freq = sum(!is.na(data[[variable]])), 
                       Mean = meantot, s.e. = meanse, LB = LB, UB = UB)
  return(round(result, 2))
  
}

pv.math <- c("PV1MATH", "PV2MATH", "PV3MATH", "PV4MATH", "PV5MATH")
pv.read <- c("PV1READ", "PV2READ", "PV3READ", "PV4READ", "PV5READ")
pv.scien <- c("PV1SCIE", "PV2SCIE", "PV3SCIE", "PV4SCIE", "PV5SCIE")

### Maths

m_finland.b <- fun.pv(pv.math, df.12[df.12$CNT=="Finland"|df.12$GENDER==1, ] , folder= getwd())
m_france.b <- fun.pv(pv.math, df.12[df.12$CNT=="France"|df.12$GENDER==1, ] , folder= getwd())
m_norway.b <- fun.pv(pv.math, df.12[df.12$CNT=="Norway"|df.12$GENDER==1, ] , folder= getwd())
m_vietnam.b <- fun.pv(pv.math, df.12[df.12$CNT=="Viet Nam"|df.12$GENDER==1, ] , folder= getwd())

m_finland.g <- fun.pv(pv.math, df.12[df.12$CNT=="Finland"|df.12$GENDER==0, ] , folder= getwd())
m_france.g <- fun.pv(pv.math, df.12[df.12$CNT=="France"|df.12$GENDER==0, ] , folder= getwd())
m_norway.g <- fun.pv(pv.math, df.12[df.12$CNT=="Norway"|df.12$GENDER==0, ] , folder= getwd())
m_vietnam.g <- fun.pv(pv.math, df.12[df.12$CNT=="Viet Nam"|df.12$GENDER==0, ] , folder= getwd())



df_maths.b <- as.data.frame(rbind(m_finland.b, m_france.b, m_norway.b, m_vietnam.b)) %>%
  mutate(Country = c("Finland", "France", "Norway", "Vietnam")) %>%
  select(Country, Mean, s.e., LB, UB, Freq)%>%
  select(Country, Mean, s.e., LB, UB, Freq)

df_maths.g <- as.data.frame(rbind(m_finland.g, m_france.g, m_norway.g, m_vietnam.g)) %>%
  mutate(Country = c("Finland", "France", "Norway", "Vietnam")) %>%
  select(Country, Mean, s.e., LB, UB, Freq)%>%
  select(Country, Mean, s.e., LB, UB, Freq)



### Reading

r_finland.b <- fun.pv(pv.read, df.12[df.12$CNT=="Finland"|df.12$GENDER==1, ] , folder= getwd())
r_france.b <- fun.pv(pv.read, df.12[df.12$CNT=="France"|df.12$GENDER==1, ] , folder= getwd())
r_norway.b <- fun.pv(pv.read, df.12[df.12$CNT=="Norway"|df.12$GENDER==1, ] , folder= getwd())
r_vietnam.b <- fun.pv(pv.read, df.12[df.12$CNT=="Viet Nam"|df.12$GENDER==1, ] , folder= getwd())

r_finland.g <- fun.pv(pv.read, df.12[df.12$CNT=="Finland"|df.12$GENDER==0, ] , folder= getwd())
r_france.g <- fun.pv(pv.read, df.12[df.12$CNT=="France"|df.12$GENDER==0, ] , folder= getwd())
r_norway.g <- fun.pv(pv.read, df.12[df.12$CNT=="Norway"|df.12$GENDER==0, ] , folder= getwd())
r_vietnam.g <- fun.pv(pv.read, df.12[df.12$CNT=="Viet Nam"|df.12$GENDER==0, ] , folder= getwd())


df_reading.b <- as.data.frame(rbind(r_finland.b, r_france.b, r_norway.b, r_vietnam.b)) %>%
  mutate(Country = c("Finland", "France", "Norway", "Vietnam")) %>%
  select(Country, Mean, s.e., LB, UB, Freq)%>%
  select(Country, Mean, s.e., LB, UB, Freq)

df_reading.g <- as.data.frame(rbind(r_finland.g, r_france.g, r_norway.g, r_vietnam.g)) %>%
  mutate(Country = c("Finland", "France", "Norway", "Vietnam")) %>%
  select(Country, Mean, s.e., LB, UB, Freq)%>%
  select(Country, Mean, s.e., LB, UB, Freq)


### Sciences

s_finland.b <- fun.pv(pv.scien, df.12[df.12$CNT=="Finland"|df.12$GENDER==1, ] , folder= getwd())
s_france.b <- fun.pv(pv.scien, df.12[df.12$CNT=="France"|df.12$GENDER==1, ] , folder= getwd())
s_norway.b <- fun.pv(pv.scien, df.12[df.12$CNT=="Norway"|df.12$GENDER==1, ] , folder= getwd())
s_vietnam.b <- fun.pv(pv.scien, df.12[df.12$CNT=="Viet Nam"|df.12$GENDER==1, ] , folder= getwd())


s_finland.g <- fun.pv(pv.scien, df.12[df.12$CNT=="Finland"|df.12$GENDER==0, ] , folder= getwd())
s_france.g <- fun.pv(pv.scien, df.12[df.12$CNT=="France"|df.12$GENDER==0, ] , folder= getwd())
s_norway.g <- fun.pv(pv.scien, df.12[df.12$CNT=="Norway"|df.12$GENDER==0, ] , folder= getwd())
s_vietnam.g <- fun.pv(pv.scien, df.12[df.12$CNT=="Viet Nam"|df.12$GENDER==0, ] , folder= getwd())


df_science.b <- as.data.frame(rbind(s_finland.b, s_france.b, s_norway.b, s_vietnam.b)) %>%
  mutate(Country = c("Finland", "France", "Norway", "Vietnam"))%>%
  select(Country, Mean, s.e., LB, UB, Freq)

df_science.g <- as.data.frame(rbind(s_finland.g, s_france.g, s_norway.g, s_vietnam.g)) %>%
  mutate(Country = c("Finland", "France", "Norway", "Vietnam"))%>%
  select(Country, Mean, s.e., LB, UB, Freq)
```

```{r,include=F}

#Plotting country differences by subject

#Maths
maths_difference <- rbind(m_finland.b, m_finland.g, m_france.b, m_france.g, m_norway.b, m_norway.g, m_vietnam.b,m_vietnam.g)
Gender <-c("Male", "Female", "Male", "Female", "Male", "Female", "Male", "Female")
Country <- c("Finland", "Finland", "France", "France", "Norway", "Norway", "Vietnam", "Vietnam")
maths_difference  <- cbind(maths_difference, Gender, Country)

plotmath <- ggplot(maths_difference, aes(x=Country, y=Mean, colour=Gender)) +
  geom_errorbar(aes(ymin=LB, ymax=UB), width=.2, position = position_dodge(width=0.2)) +
  geom_line(position = position_dodge(width=0.2)) +
  geom_point(size=2, shape=21, fill="white", position = position_dodge(width=0.2)) +
  geom_text(aes(label=Mean),hjust=-0.1, vjust=-0.1) +
  ggtitle("Mean scores for Maths by gender and country")

#Reading
reading_difference <- rbind(r_finland.b, r_finland.g, r_france.b, r_france.g, r_norway.b, r_norway.g, r_vietnam.b,r_vietnam.g)
Gender <-c("Male", "Female", "Male", "Female", "Male", "Female", "Male", "Female")
Country <- c("Finland", "Finland", "France", "France", "Norway", "Norway", "Vietnam", "Vietnam")
reading_difference  <- cbind(reading_difference, Gender, Country)

plotreading <- ggplot(reading_difference, aes(x=Country, y=Mean, colour=Gender)) +
  geom_errorbar(aes(ymin=LB, ymax=UB), width=.2, position = position_dodge(width=0.2)) +
  geom_line(position = position_dodge(width=0.2)) +
  geom_point(size=2, shape=21, fill="white", position = position_dodge(width=0.2)) +
  geom_text(aes(label=Mean),hjust=-0.1, vjust=-0.1) +
  ggtitle("Mean scores for Reading by gender and country ")

#Science
science_difference <- rbind(s_finland.b, s_finland.g, s_france.b, s_france.g, s_norway.b, s_norway.g, s_vietnam.b,s_vietnam.g)
Gender <-c("Male", "Female", "Male", "Female", "Male", "Female", "Male", "Female")
Country <- c("Finland", "Finland", "France", "France", "Norway", "Norway", "Vietnam", "Vietnam")
science_difference  <- cbind(science_difference, Gender, Country)

plotscience<- ggplot(science_difference,aes(x=Country, y=Mean, colour=Gender)) + 
  geom_errorbar(aes(ymin=LB, ymax=UB), width=.2, position = position_dodge(width=0.2)) +
  geom_line(position = position_dodge(width=0.2)) +
  geom_point(size=2, shape=21, fill="white", position = position_dodge(width=0.2)) +
  geom_text(aes(label=Mean),hjust=-0.1, vjust=-0.1) 
  ggtitle("Mean scores for Science by gender and country")

  

```

```{r,echo=F,fig.show="hold",out.width="50%",warning=F,message=F}

plotmath
plotreading
plotscience

```

The easiest way to represent the data  is to input the different mean data point per gender and country with the confidence interval around them (semi-boxplot).
 To analyze these graphs, we will proceed by subject analyzing for each subject the score for each gender.
 
 For Math, it seems that men perform sligthly better than women in all countries (naive mean comparison),we cannot however say if this difference is statistically significant. We also notice that French boys perform worse compared to the other male pupils in the sample while vietnamese girls perform better than the other female pupils.
 Again, we cannot say with certainty if that is the case.
 
 For Reading, the picture is clearer, girls perfect significantly better than boys in all countries. It is also interesting to mention that the two countries where guys perform the worse (Finland and Norway), are alos the countries where the girls perform the best.
 
 For Science, there is no statistical difference between the mean scores of boys and girls in any of the four countries. Even comparing between countries, we cannot conclude that one country's boys or girls perform better than another.
 
 
 
 
## 5.
 
 
```{r,include=F}

##Finland

df_self_finland_male <- subset(df.12, df.12$GENDER==1 & df.12$CCODE=="FIN")
self_finland_male <- fun("SCMAT", df_self_finland_male)

df_self_finland_female <- subset(df.12, df.12$GENDER==0 & df.12$CCODE=="FIN")
self_finland_female <- fun("SCMAT", df_self_finland_female)

#France
df_self_france_male <- subset(df.12, df.12$GENDER==1 & df.12$CCODE=="FRA")
self_france_male <- fun("SCMAT", df_self_france_male)

df_self_france_female <<- subset(df.12, df.12$GENDER==0 & df.12$CCODE=="FRA")
self_france_female <- fun("SCMAT", df_self_france_female)

#Norway
df_self_norway_male <- subset(df.12, df.12$GENDER==1 & df.12$CCODE=="NOR")
self_norway_male <- fun("SCMAT", df_self_norway_male)

df_self_norway_female <- subset(df.12, df.12$GENDER==0 & df.12$CCODE=="NOR")
self_norway_female <- fun("SCMAT", df_self_norway_female)

##Vietnam

df_self_vietnam_male <- subset(df.12, df.12$GENDER==1 & df.12$CCODE=="VNM")
self_vietnam_male <- fun("SCMAT", df_self_vietnam_male)

df_self_vietnam_female <- subset(df.12, df.12$GENDER==0 & df.12$CCODE=="VNM")
self_vietnam_female <- fun("SCMAT",df_self_vietnam_female)


Country <- c("Finland","France", "Norway","Vietnam")

table_self_male <- rbind(self_finland_male, self_france_male,  self_norway_male,  self_vietnam_male)

final_table_self_male <- cbind(Country,table_self_male) %>%select(Country, Mean, s.e.,LB,UB, Freq)

table_self_female <- rbind(self_finland_female, self_france_female,  self_norway_female,  self_vietnam_female)

final_table_self_female <- cbind(Country,table_self_female) %>%
  select(Country, Mean, s.e.,LB,UB, Freq)

```

The fun function is very similar to the fun.pv function.
First, we input a function of two variables in the fun object.
Second, we compute the weighted mean of the 80 balanced repetitions.
Third, we compute the  weighted mean value of the variable in question using normal individual weights.
Fourth we compute the mean standard error by using the BRR formula, meaning that we do the difference between the mean of the balanced replication of the variable minus the weighted mean of the variable itsel, the difference bein squared.
Fifth, we compue the upper and lower bound of the 95% confidence interval, by using the mean of the variable.
Lastly, we put all the variables wanted into a dataframe and display the result.


\begin{table}[H] \centering 
  \caption{Subjective Assessment: Self Concept in Mathematics} 
  \label{} 
\begin{tabular}{@{\extracolsep{5pt}}lccccc}
\\\hline  
 & &\multicolumn{1}{c}{Finland} & \multicolumn{1}{c}{France} & \multicolumn{1}{c}{Norway} & \multicolumn{1}{c}{Vietnam}\\
Gender & Desc.stat  &  &  & &   \\
\hline \\[-1.8ex] 
Male & Mean  & 0.23 &  0.07 &  0.08 & -0.08        \\
  & Std.Error  & (0.03) & (0.03) & (0.03) & (0.02)      \\
  & CI & [0.18;0.28] & [0.02;0.13]  & [0.02;0.13] &  [-0.13;-0.05]    \\
  & & & & &  \\ 
 \hline
  & & & &   \\ 
Female & Mean  & -0.17 &  -0.39 &  -0.27   &  -0.28   \\
  & Std.Error  & (0.03) & (0.03) & (0.03)  & (0.02)  \\
  & CI & [-0.22;-0.12] & [-0.45;-0.34] & [-0.34;-0.21]  & [-0.31;-0.24]  \\
& & & & &  \\ 

 \hline 
 \hline
  & Observations & 5,689 & 3,015 & 3,018 & 3,299 \\ 
\hline 
\hline \\[-1.8ex] 
\end{tabular}
\end{table}


We notice a consistent pattern in the assessment in Math. Boys seem to always see themselves as better at math than girls assess themselves.  We also see that  except for vietnam, in all countries boys have a positive views of their skill set in math whereas for girls it is always negative.
Furthermore, we notice that Finnish children (boys and girls) rank higher when it comes to self assessment than their peers.


\pagebreak



